### 复制

在Redis中，可以通过执行`SLAVEOF`命令或者设置`slaveof`选项，让一个服务器（slave）去复制另一个服务器（master）。

Redis的复制功能分为`同步(psync)`和`命令传播`两个操作

- 同步操作用于将从服务器的数据库更新至主服务器当前所处的数据看状态。
- 命令传播用于在主服务器数据库状态被修改，导致主从数据库状态不一致时，让主从服务器数据库重回到一致状态。

#### 同步

同步分为完整重同步和部分重同步两种模式

##### 完整重同步

用于处理初次复制，执行步骤：

1. 从服务器向主服务器发送`PSYNC`命令。
2. 主服务器执行`BGSAVE`命令，在后台生成`RDB`文件，并使用一个缓冲区记录之后执行的命令。
3. 主服务器生成`RDB`文件后，向从服务器发送`RDB`文件，从服务器载入`RDB`文件。
4. 主服务器将缓冲区中的命令发送给从服务器，从服务器执行后，将数据库更新至和主服务器同步的状态。

##### 部分重同步

用于处理断线后重复制。当从服务器重新连接上主服务器时，如果条件允许，主服务器会将从服务器断线期间执行的命令发送给从服务器，从服务器数据库执行命令完毕后即可恢复至与主服务器同步状态。

- 构成部分重同步的三部分

  - 主从服务器的复制偏移量

    - 主服务器每次向从服务器发送N个字节的数据，就将自己的复制偏移量加N。
    - 从服务器每次收到主服务器发来的N个字节的数据，就将自己的复制偏移量加N。

  - 主服务器的复制积压缓冲区

    - 复制积压缓冲区是一个固定长度的FIFO队列，默认大小1MB。

    - 当主服务器向从服务器进行命令传播时，还会将命令写入复制积压缓冲区。复制积压缓冲区中保存着最近传播的命令，并且还维护了每个字节的复制偏移量。

      ![image-20190729152939908](assets/image-20190729152939908.png)

    - 当从服务器重新连接上主服务器时，会发送`PSYNC`命令，将自己的复制偏移量`offset`发送给主服务器，主服务器会根据复制偏移量决定对从服务器执行完整重同步还是部分重同步：

      - 如果偏移量为`offset + 1`的数据在队列中，则执行部分重同步。
      - 如果偏移量为`offset + 1`的数据不在队列中，则执行完整重同步。

  - 服务器的运行ID

    - 每个Redis服务器都会有一个运行ID。
    - 从服务器对主服务器初次复制时，主服务器会将自己的运行ID传送至从服务器，服务器将主服务器的运行ID保存下来。
    - 当从服务器断线后重新连接上主服务器时，会向主服务器发送之前保存的主服务器运行ID
      - 如果发送的运行ID与主服务器的运行ID一致，则主服务器尝试执行部分重同步。
      - 如果发送的运行ID与主服务器的运行ID不一致，则主服务器执行完全重同步。

  #### 复制的实现

  1. 设置主服务器的地址和端口

     - 从服务器向主服务器发送`SLAVEOF <master_ip> <master_port>`命令。

     - 从服务器保存主服务器的地址和端口信息：

       ``` c
       struct redisServer {
         char *masterhost;
         char *masterport;
       }
       ```

     - 主服务器向发送`SLAVEOF`命令的客户端返回`OK`，之后开始复制。

  2. 建立套接字连接

     - 从服务器创建连向主服务器的套接字连接。
     - 从服务器为这个套接字关联一个专门用于复制的文件时间处理器。
     - 主服务器为这个套接字创建相应的客户端状态，将从服务器看做客户端。

  3. 从服务器发送`PING`命令

     - 如果主服务器返回了`PONG`，那么连接正常，继续下一个步骤。
     - 如果读取`PING`命令回复超时，或者主服务器返回了一个错误，则断开并重连主服务器。

  4. 身份验证

  5. 向主服务器发送监听端口信息

  6. 同步

  7. 命令传播

     - 从服务器默认会以每秒一次的频率向主服务器发送命令：`REPLCONF ACK <replication_offset>`，主要有三个作用：
       1. 检测主从服务器的连接状态
       2. 辅助实现`min-slaves`配置选项
       3. 检测命令丢失（补发网络故障导致的缺失数据）

### Sentinel

